// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/array dojo/_base/event dojo/_base/lang dojo/_base/html dojo/_base/Color dojo/DeferredList esri/layers/GraphicsLayer esri/graphic esri/geometry/Extent esri/geometry/Point esri/symbols/PictureMarkerSymbol esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/renderers/SimpleRenderer esri/request esri/tasks/query esri/tasks/QueryTask esri/symbols/jsonUtils".split(" "),function(w,q,x,n,m,k,y,z,f,A,r,s,l,g,B,C,u,v,t){return w("ClusterLayer",[z],{constructor:function(a){this.clusterGraphics=
null;this.cancelRequest=!1;this.clusterSize=120;this._singles=[];this.initalLoad=this._showSingles=!0;this.updateFeatures=[];this._parentLayer=a.parentLayer;this.name=a.name;this._map=a.map;this.color=k.fromString(a.color||"#ff0000");this.symbolData=a.lyrInfo.symbolData;this.itemId=a.lyrInfo.itemId;this.refresh=a.lyrInfo.refresh;this.node=a.node;this._features=a.features;this.id=a.id;this.infoTemplate=a.infoTemplate;this.url=a.lyrInfo.url;this._testRenderer=a.lyrInfo.renderer;a.originOperLayer&&this._getInfoTemplate(a.originOperLayer);
this._setupSymbols();this._setFieldNames();this._initFeatures()},_initFeatures:function(){"undefined"===typeof this._features?"undefined"!==typeof this.url?this.loadData(this.url):this.loaded="error":this.loaded=!0;"error"!==this.loaded&&(this.extentChangeSignal=this._map.on("extent-change",n.hitch(this,this.handleMapExtentChange)),this.clickSignal=this.on("click",n.hitch(this,this.handleClick)))},_getInfoTemplate:function(a){if(a&&a.parentLayerInfo&&a.parentLayerInfo.controlPopupInfo&&(a=a.parentLayerInfo.controlPopupInfo.infoTemplates)&&
this.url){var b=this.url.split("/").pop();b&&(a.indexOf?-1<a.indexOf(b)&&(this.infoTemplate=a[b].infoTemplate):a.hasOwnProperty(b)&&(this.infoTemplate=a[b].infoTemplate))}},_setFieldNames:function(){this._fieldNames=[];if(this.infoTemplate&&"undefined"!==typeof this.infoTemplate.info)for(var a=this.infoTemplate.info.fieldInfos,b=0;b<a.length;b++)a[b].visible&&this._fieldNames.push(a[b].fieldName);1>this._fieldNames.length&&(this._fieldNames=["*"])},clearSingles:function(a){q.forEach(a||this._singles,
function(a){this.remove(a)},this);this._singles.length=0},_getSingleGraphic:function(a){a=new f(new r(a.geometry.x,a.geometry.y,this._map.spatialReference),null,a.attributes);a.setSymbol(this._singleSym);return a},_addSingles:function(a){q.forEach(a,function(a){a=this._getSingleGraphic(a);this._singles.push(a);this._showSingles&&this.add(a)},this);this._map.infoWindow.setFeatures(this._singles)},initalCount:function(a){var b=new u;b.returnGeometry=!1;b.geometry=this._map.extent;(new v(a)).executeForIds(b).then(n.hitch(this,
function(a){this.node&&(this.node.innerHTML=a?a.length.toLocaleString():0,m.setStyle(this.node.parentNode.childNodes[1],"right",this.node.clientWidth+"px"),a=70-this.node.parentNode.childNodes[1].childNodes[0].clientHeight,2<a?m.setStyle(this.node.parentNode.childNodes[1],"top",a/2+"px"):m.setStyle(this.node.parentNode.childNodes[1],"top","2px"))}))},loadData:function(a){if(0<a.length){this.initalCount(a);var b=new u;b.where="1\x3d1";b.returnGeometry=!1;this.queryPending=!0;(new v(a)).executeForIds(b).then(n.hitch(this,
function(b){if(b){this.queryIDs=b;b=[];var e,h;e=0;for(h=this.queryIDs.length;e<h;e+=1E3){var d=this.queryIDs.slice(e,e+1E3);b.push(C({url:a+"/query",content:{f:"json",outFields:this._fieldNames.join(),objectids:d.join(),returnGeometry:"true",outSR:this._map.spatialReference.wkid}}))}this._features=[];this.cancelRequest?console.log("Cancelled ClusterLayer 1"):(new y(b)).then(n.hitch(this,function(a){this.queryPending=!1;if(this.cancelRequest)console.log("Cancelled ClusterLayer 2");else if(a){for(var b=
this._map.spatialReference,c=[],d=0;d<a.length;d++)for(var e=0;e<a[d][1].features.length;e++){var h=a[d][1].features[e];if("undefined"!==typeof h.geometry){var g=new r(h.geometry.x,h.geometry.y,b),g=new f(g);g.setAttributes(h.attributes);this.infoTemplate&&g.setInfoTemplate(this.infoTemplate);c.push(g)}}a=!0;1E4>c&&(a=JSON.stringify(this._features)!==JSON.stringify(c));a&&(this._features=c,this.clusterFeatures());this.loaded=!0}}))}}))}},handleClick:function(a){var b=[];if(a.graphic&&(b=a.graphic,
b.attributes)){var c=b.attributes;c.Data&&1<c.Data.length?(this.clearSingles(this._singles),b=c.Data,a.stopPropagation(),this._addSingles(b),this._map.infoWindow.setFeatures(c.Data)):this._map.infoWindow.setFeatures([b])}this._map.infoWindow.show(a.mapPoint);x.stop(a)},handleMapExtentChange:function(a){if(a.levelChange)this.clusterFeatures();else if(a.delta){var b=a.delta;a=Math.abs(b.x);b=Math.abs(b.y);(50<a||50<b)&&this.clusterFeatures()}},refreshFeatures:function(a){if(this.itemId){a=a.featureSet.features;
var b=!0;1E4>a.length&&(b=JSON.stringify(this.updateFeatures)!==JSON.stringify(a));if(b){this._features=[];this._parentLayer.clear();var b=this._parentLayer.spatialReference,c;this._parentLayer.renderer?c=this._parentLayer.renderer:this._testRenderer&&(c=this._testRenderer);for(var e=0;e<a.length;e++){var h=a[e];if(h.geometry){this._features.push({attributes:h.attributes,geometry:new r(h.geometry.x,h.geometry.y,b)});var d=new f(this.getGraphicOptions(h,b,c));d.setAttributes(h.attributes);this._infoTemplate&&
d.setInfoTemplate(this._infoTemplate);d.setSymbol(c.getSymbol(d));this._parentLayer.add(d)}else console.log("Null geometry skipped")}this.clusterFeatures()}this.updateFeatures=a}else this.url&&this.loadData(this.url)},getGraphicOptions:function(a,b,c){return"undefined"!==typeof a.geometry.rings?{geometry:{rings:a.geometry.rings,spatialReference:{wkid:b.wkid}}}:"undefined"!==typeof a.geometry.paths?{geometry:{paths:a.geometry.paths,spatialReference:{wkid:b.wkid}}}:{geometry:new r(a.geometry.x,a.geometry.y,
a.geometry.spatialReference),symbol:c.symbol}},flashFeatures:function(){this.flashGraphics(this.graphics)},flashSingle:function(a){if("undefined"===typeof a.symbol){var b=new g(g.STYLE_NULL,new k(0,0,0,0),0),c=this.color.toRgb();a.setSymbol(new l(l.STYLE_CIRCLE,9,b,new k([c[0],c[1],c[2],0.5])))}this.flashGraphics([a])},flashGraphics:function(a){var b=new g(g.STYLE_SOLID,this.color,7),c=new g(g.STYLE_SOLID,this.color,3),e=new g(g.STYLE_NULL,new k(0,0,0,0),0),h=0;clearInterval(this.s);this.s=setInterval(n.hitch(this,
function(){for(var d=0;d<a.length;d++){var g=a[d],f;if(h%2){if(f=g.symbol)"function"===typeof f.setOutline&&f.setOutline(b),g.setSymbol(f)}else if(f=g.symbol)"function"===typeof f.setOutline&&f.setOutline(c),g.setSymbol(f)}this.redraw();h+=1;if(5===h){clearInterval(this.s);for(d=0;d<a.length;d++)g=a[d],f=g.symbol,"undefined"!==typeof f&&("function"===typeof f.setOutline&&f.setOutline(e),g.setSymbol(f));this.redraw();this.clusterFeatures()}}),600)},setColor:function(a){this.color=a},cancelPendingRequests:function(){console.log("Cancel Query...");
this.queryPending&&(this.cancelRequest=!0);this.removeEventListeners()},removeEventListeners:function(){this.extentChangeSignal&&(this.extentChangeSignal.remove(),this.extentChangeSignal=null);this.clickSignal&&(this.clickSignal.remove(),this.clickSignal=null)},clusterFeatures:function(){this.clear();this._map.infoWindow.isShowing&&this._map.infoWindow.hide();var a=this._features,b=0;if("undefined"!==typeof a){if(0<a.length){var c=this.clusterSize;this.clusterGraphics=[];for(var e=this._map.spatialReference,
h=this._map.extent,d=new r(h.xmin,h.ymax,e),g=Math.ceil(this._map.height/c),l=Math.ceil(this._map.width/c),k=h.getWidth()/this._map.width*c,c=h.getHeight()/this._map.height*c,h=0;h<g;h++)for(var n=0;n<l;n++){var p=d.x+k*n,m=d.y-c*h,m=new A(p,m-c,p+k,m,e),p=[],q;for(q in a){var s=a[q];m.contains(s.geometry)&&(b+=1,p.push(s))}0<p.length&&(m=this.getClusterCenter(p),this.clusterGraphics.push({center:m,graphics:p}))}for(var u in this.clusterGraphics)a=this.clusterGraphics[u],e=a.graphics.length,d=a.graphics,
g=19*e.toString().length,this._setSymbols(g+5,g+1),d={Count:e,Data:d},1<e?"undefined"!==typeof this.symbolData?"CustomSymbol"!==this.symbolData.symbolType?(this.add(new f(a.center,this.csym,d)),this.add(new f(a.center,this.csym3,d))):(this.add(new f(a.center,this.csym,d)),this.add(new f(a.center,this.psym,d))):(this.add(new f(a.center,this.csym,d)),this.add(new f(a.center,this.psym,d))):(a=a.graphics[0].geometry,this.renderer&&(this.renderer.hasOwnProperty("getSymbol")&&"LayerSymbol"===this.symbolData.symbolType?
(a=new f(a,null,d.Data[0].attributes),e=this.renderer.getSymbol(a),a.setInfoTemplate(this.infoTemplate),a.setSymbol(e),this.add(a)):this.renderer.hasOwnProperty("symbol")&&"LayerSymbol"===this.symbolData.symbolType?(a=new f(a,null,d.Data[0].attributes),a.setInfoTemplate(this.infoTemplate),a.setSymbol(t.fromJson(this.renderer.symbol)),this.add(a)):"EsriSymbol"===this.symbolData.symbolType?this.add(new f(a,t.fromJson(this.symbolData.symbol),d)):"LayerSymbol"!==this.symbolData.symbolType?this.add(new f(a,
this.psym,d)):(a=this.renderer.symbol?new f(a,this.renderer.symbol,d):new f(a,this.psym,d),a.setInfoTemplate(this.infoTemplate),this.add(a))))}this._updateNode(b)}},_updateNode:function(a){this.node&&(this.node.innerHTML=a.toLocaleString(),a=this.node.clientWidth&&0<this.node.clientWidth?this.node.clientWidth:10*a.toLocaleString().length,m.setStyle(this.node.parentNode.childNodes[1],"right",a+"px"),0===this.node.parentNode.childNodes[1].childNodes[0].clientHeight?(this.initalLoad=!0,a=60):(a=70-this.node.parentNode.childNodes[1].childNodes[0].clientHeight,
this.initalLoad=!1),2<a?m.setStyle(this.node.parentNode.childNodes[1],"top",a/2+"px"):m.setStyle(this.node.parentNode.childNodes[1],"top","2px"))},_updatePanelTime:function(a){this.pageTitle.innerHTML="\x3cdiv\x3e\x3c/div\x3e";var b="";""!==this.config.mainPanelText&&(b=this.config.mainPanelText+" ");this.pageTitle.innerHTML=b+(new Date(a)).toLocaleDateString(navigator.language,{month:"2-digit",day:"2-digit",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})},_setSymbols:function(a,b){var c=
this.color.toRgb(),e,h,d;if("undefined"!==typeof this.symbolData){var f;"custom"===this.backgroundClusterSymbol?f=c:(e=t.fromJson(this.backgroundClusterSymbol),0===e.outline.color.a||0===e.outline.width?(h=g.STYLE_NULL,d=0):(h=g.STYLE_SOLID,d=e.outline.width));e?(c=g(h,e.outline.color,d),f=e.color.toRgb(),this.csym=new l(l.STYLE_CIRCLE,a,c,new k([f[0],f[1],f[2],0.75]))):this.csym=new l(l.STYLE_CIRCLE,a,null,new k([f[0],f[1],f[2],0.75]));c=this.symbolData.s;(c=-1<c.indexOf("${appPath}")?this.symbolData.s.replace("${appPath}",
window.location.origin+window.location.pathname):this.symbolData.s?this.symbolData.s:this.icon.imageData)&&"CustomIcon"===this.symbolData.iconType?this.psym=new s(c,a-6,a-6):c&&"LayerIcon"===this.symbolData.iconType?this.psym=t.fromJson(this.symbolData.symbol):(c=g(this.icon.outline.style,this.icon.outline.color,this.icon.outline.width),this.psym=new l(this.icon.style,this.icon.size,c,this.icon.color));this.csym2=n.clone(this.psym);this.csym3=n.clone(this.csym2);"undefined"!==typeof this.csym2.xoffset&&
(this.csym3.xoffset=0);"undefined"!==typeof this.csym2.yoffset&&(this.csym3.yoffset=0)}else e=new g(g.STYLE_NULL,new k(0,0,0,0),0),this.csym=new l(l.STYLE_CIRCLE,a,e,new k([c[0],c[1],c[2],0.5])),this.psym=new s(this.icon.url,a-10,a-10),this.psym2=new s(this.icon.url,b-7,b-7),e=new g(g.STYLE_NULL,new k(0,0,0,0),0),this.csym2=new l(l.STYLE_CIRCLE,b,e,new k([c[0],c[1],c[2],0.5]))},_setupSymbols:function(){if("undefined"!==typeof this.symbolData){this.backgroundClusterSymbol=this.symbolData.clusterSymbol;
this.icon=this.symbolData.icon;"LayerSymbol"===this.symbolData.symbolType?this._parentLayer.renderer?this.renderer=this._parentLayer.renderer:this.symbolData.renderer&&(this.renderer=this._testRenderer):this.renderer=new B(t.fromJson(this.symbolData.symbol));var a=this.color.toRgb(),b=new g(g.STYLE_NULL,new k(0,0,0,0),0);this._singleSym=new l(l.STYLE_CIRCLE,9,b,new k([a[0],a[1],a[2],0.5]))}},getClusterCenter:function(a){var b=0,c=0,e=a.length;q.forEach(a,function(a){b+=a.geometry.x;c+=a.geometry.y},
this);return new r(b/e,c/e,a[0].geometry.spatialReference)},_clear:function(){this.clear();this._features=[]}})});