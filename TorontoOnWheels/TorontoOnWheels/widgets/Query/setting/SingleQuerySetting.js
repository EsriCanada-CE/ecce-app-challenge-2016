// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Query/setting/SingleQuerySetting.html":'\x3cdiv\x3e\r\n\t\x3ctable data-dojo-attach-point\x3d"generalTable" class\x3d"general" cellpadding\x3d"0" cellspacing\x3d"0"\x3e\r\n\t\t\x3ctbody\x3e\r\n\t\t\t\x3ctr\x3e\r\n\t\t\t\t\x3ctd class\x3d"first-td"\x3e${nls.querySource}\x3c/td\x3e\r\n\t\t\t\t\x3ctd class\x3d"second-td"\x3e\r\n\t\t\t\t\t\x3ctable cellpadding\x3d"0" cellspacing\x3d"0" style\x3d"width:100%;border-collapse:collapse;"\x3e\r\n\t\t\t\t\t\t\x3ctbody\x3e\r\n\t\t\t\t\t\t\t\x3ctr\x3e\r\n\t\t\t\t\t\t\t\t\x3ctd style\x3d"width:auto;"\x3e\r\n\t\t\t\t\t\t\t\t\t\x3cdiv data-dojo-attach-point\x3d"urlTextBox" data-dojo-type\x3d"dijit/form/ValidationTextBox" data-dojo-props\x3d\'required:true,trim:true,disabled:true\' style\x3d"width:100%;"\x3e\x3c/div\x3e\r\n\t\t\t\t\t\t\t\t\x3c/td\x3e\r\n\t\t\t\t\t\t\t\t\x3ctd style\x3d"width:120px;"\x3e\r\n\t\t\t\t\t\t\t\t\t\x3cdiv data-dojo-attach-event\x3d"onclick:_onBtnSetSourceClicked" class\x3d"jimu-btn jimu-float-trailing"\x3e${nls.setSource}\x3c/div\x3e\r\n\t\t\t\t\t\t\t\t\x3c/td\x3e\r\n\t\t\t\t\t\t\t\x3c/tr\x3e\r\n\t\t\t\t\t\t\x3c/tbody\x3e\r\n\t\t\t\t\t\x3c/table\x3e\r\n\t\t\t\t\x3c/td\x3e\r\n\t\t\t\x3c/tr\x3e\r\n\t\t\t\x3ctr\x3e\r\n\t\t\t\t\x3ctd class\x3d"first-td"\x3e${nls.queryName}\x3c/td\x3e\r\n\t\t\t\t\x3ctd class\x3d"second-td"\x3e\r\n\t\t\t\t\t\x3cdiv data-dojo-attach-point\x3d"queryNameTextBox" data-dojo-type\x3d"dijit/form/ValidationTextBox" data-dojo-props\x3d\'required:true,trim:true\' style\x3d"width:100%;" data-dojo-attach-event\x3d"change:_onQueryNameChanged,blur:_onQueryNameBlurred"\x3e\x3c/div\x3e\r\n\t\t\t\t\x3c/td\x3e\r\n\t\t\t\x3c/tr\x3e\r\n\t\t\x3c/tbody\x3e\r\n\t\x3c/table\x3e\r\n\t\x3cdiv data-dojo-attach-point\x3d"detailSection" class\x3d"detail"\x3e\r\n\t\t\x3cdiv data-dojo-attach-point\x3d"definitionTabNode"\x3e\r\n\t\t\t\x3cdiv style\x3d"position:relative;width:100%;height:100%;" data-dojo-attach-point\x3d"filterDiv"\x3e\r\n\t\t\t\x3c/div\x3e\r\n\t\t\x3c/div\x3e\r\n\t\t\x3cdiv data-dojo-attach-point\x3d"resultsTabNode"\x3e\r\n\t\t\t\x3cdiv data-dojo-attach-point\x3d"popupContainer" style\x3d"width:90%;"\x3e\x3c/div\x3e\r\n\t\t\t\x3cdiv data-dojo-attach-point\x3d"symbolSection" class\x3d"symbol-section" style\x3d"margin-top:18px;"\x3e\r\n\t\t\t\t\x3cdiv style\x3d"margin-bottom:11px;"\x3e${nls.setLayerSymbolTip}\x3c/div\x3e\r\n\t\t\t\t\x3cdiv data-dojo-attach-point\x3d"layerSymbolPicker" data-dojo-type\x3d"jimu/dijit/SymbolPicker"\x3e\x3c/div\x3e\r\n\t\t\t\x3c/div\x3e\r\n\t\t\x3c/div\x3e\r\n\t\x3c/div\x3e\r\n\t\x3cdiv data-dojo-attach-point\x3d"shelter" data-dojo-type\x3d"jimu/dijit/LoadingShelter" data-dojo-props\x3d\'hidden:true\'\x3e\x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/text!./SingleQuerySetting.html dojo/_base/lang dojo/_base/array dojo/_base/html dojo/on dojo/Evented jimu/utils jimu/dijit/TabContainer3 jimu/dijit/Message jimu/dijit/_QueryableLayerSourcePopup ./PopupConfig esri/request esri/symbols/jsonUtils jimu/dijit/Filter jimu/dijit/SymbolPicker jimu/dijit/LoadingShelter dijit/form/ValidationTextBox".split(" "),function(l,m,n,p,q,e,r,f,h,s,g,t,k,u,v,w,x,y){return l([m,
n,p,s],{baseClass:"jimu-widget-single-query-setting",templateString:q,map:null,nls:null,tr:null,appConfig:null,_layerDefinition:null,postCreate:function(){this.inherited(arguments);this._initSelf()},destroy:function(){this.tr=null;delete this.tr;this.inherited(arguments)},setConfig:function(a){this.config=a;if(this._isObject(this.config)){var b=a.url||"";b&&"string"===typeof b&&(this._layerDefinition&&this._layerDefinition.url===b?(this.tab.hideShelter(),this._resetByConfig(this.config,this._layerDefinition)):
(this._layerDefinition=null,this.showBigShelter(),w({url:b,handAs:"json",content:{f:"json"},callbackParamName:"callback"}).then(e.hitch(this,function(a){this.domNode&&(this.hideBigShelter(),this.tab.hideShelter(),this._layerDefinition=a,this._layerDefinition.url=b,this._resetByConfig(this.config,this._layerDefinition))}),e.hitch(this,function(a){console.error(a);this.domNode&&this.hideBigShelter()}))))}},getConfig:function(){var a={name:"",url:"",filter:{useFilter:"",filterInfo:""},popup:"",resultsSymbol:"",
objectIdField:"",orderByFields:[]};if(!this._layerDefinition)return this.scrollToDom(this.generalTable),new k({message:this.nls.setSourceTip}),null;a.url=this._layerDefinition.url;var b=g.stripHTML(this.queryNameTextBox.get("value"));if(!b)return this.showValidationErrorTip(this.queryNameTextBox),null;a.name=b;b=this.filter.toJson();if(!b)return new k({message:this.nls.setFilterTip}),null;a.filter=b;b=this.popupConfig.getConfig();if(!b)return null;a.orderByFields=b.orderByFields;delete b.orderByFields;
a.popup=b;if(this._isTable(this._layerDefinition))a.resultsSymbol=null;else if(b=this.layerSymbolPicker.getSymbol())a.resultsSymbol=b.toJson();else return null;this._layerDefinition.objectIdField?a.objectIdField=this._layerDefinition.objectIdField:(b=r.filter(this._layerDefinition.fields,e.hitch(this,function(a){return"esriFieldTypeOID"===a.type})),0<b.length&&(a.objectIdField=b[0].name));this.tr._layerDefinition=this._layerDefinition;return a},scrollToDom:function(a){a=f.coords(a).y;var b=f.coords(this.domNode).y;
this.domNode.parentNode.scrollTop=a-b},showValidationErrorTip:function(a){!a.validate()&&a.domNode&&a.focusNode&&(a.focusNode.focus(),setTimeout(e.hitch(this,function(){a.focusNode.blur()}),100))},showBigShelter:function(){this.emit("show-shelter")},hideBigShelter:function(){this.emit("hide-shelter")},showQueryDefinition:function(){this.tab.selectTab(this.nls.queryDefinition)},showResultsSetting:function(){this.tab.selectTab(this.nls.resultsSetting)},_initSelf:function(){this._initFilter();this._initPopupConfig();
this._initTabs()},_initFilter:function(){this.filter=new y({enableAskForValues:!0,noFilterTip:this.nls.noFilterTip,style:"width:100%;margin-top:22px;"});this.filter.placeAt(this.filterDiv)},_initTabs:function(){this.tab=new t({tabs:[{title:this.nls.queryDefinition,content:this.definitionTabNode},{title:this.nls.resultsSetting,content:this.resultsTabNode}]});this.tab.placeAt(this.detailSection);this.tab.showShelter()},_initPopupConfig:function(){this.popupConfig=new v({nls:this.nls,sqs:this});this.popupConfig.placeAt(this.popupContainer)},
_getRandomString:function(){var a=Math.random().toString();return a=a.slice(2,a.length)},_onQueryNameChanged:function(){this.emit("name-change",this.queryNameTextBox.get("value"))},_onQueryNameBlurred:function(){var a=g.stripHTML(this.queryNameTextBox.get("value"));this.queryNameTextBox.set("value",a)},_clear:function(){this.urlTextBox.set("value","");this._layerDefinition=null;this.queryNameTextBox.set("value","");this.filter.reset();this.tab.showShelter();this.popupConfig.clear();this.layerSymbolPicker.reset()},
_onBtnSetSourceClicked:function(){var a=new u({titleLabel:this.nls.setDataSource,dijitArgs:{multiple:!1,createMapResponse:this.map.webMapResponse,portalUrl:this.appConfig.portalUrl,style:{height:"100%"}}});this.own(h(a,"ok",e.hitch(this,function(b){var c=a.getSelectedRadioType();a.close();var d=a=null;"map"===c&&(c=b.layerInfo&&b.layerInfo.layerObject)&&"function"===typeof c.getDefinitionExpression&&(d=c.getDefinitionExpression());this.setNewLayerDefinition(b.name,b.url,b.definition,null,d)})));this.own(h(a,
"cancel",e.hitch(this,function(){a.close();a=null})));a.startup()},setNewLayerDefinition:function(a,b,c,d,e){c.name=a;c.url=b;b!==(this._layerDefinition&&this._layerDefinition.url)&&this._resetByNewLayerDefinition(c,d,e)},_isImageServiceLayer:function(a){return-1<a.url.indexOf("/ImageServer")},_isTable:function(a){return"Table"===a.type},_showSymbolSection:function(){f.setStyle(this.symbolSection,"display","block")},_hideSymbolSection:function(){f.setStyle(this.symbolSection,"display","none")},_resetByNewLayerDefinition:function(a,
b,c){this._clear();if(a){this._layerDefinition=a;var d=a.url;this.urlTextBox.set("value",d);this.queryNameTextBox.set("value",b||a.name);this.tab.hideShelter();this.filter.reset();this._layerDefinition&&this.filter.buildByExpr(d,c||"1\x3d1",this._layerDefinition);b="";a.displayField&&(b="${"+a.displayField+"}");this.popupConfig.setConfig({title:b,fields:[],orderByFields:[]});this.popupConfig.updateSortingIcon(this._layerDefinition);b="";this._isImageServiceLayer(a)?b="fill":this._isTable(a)?b="":
a.geometryType&&(a=g.getTypeByGeometryType(a.geometryType),"point"===a?b="marker":"polyline"===a?b="line":"polygon"===a&&(b="fill"));b?(this._showSymbolSection(),this.layerSymbolPicker.showByType(b)):(this._hideSymbolSection(),this.layerSymbolPicker.reset())}},_resetByConfig:function(a,b){var c=e.clone(a);this.urlTextBox.set("value",c.url);this.queryNameTextBox.set("value",c.name||"");var d=c.filter;this._isObject(d)&&(this.filter.reset(),this._isObject(d)?this.filter.buildByFilterObj(b.url,d,b):
this.filter.buildByExpr(b.url,"1\x3d1",b),this.popupConfig.clear(),this._isObject(c.popup)||(c.popup={title:"",fields:[]}),c.popup.fields&&0<=c.popup.fields.length||(c.popup.fields=[]),c.popup.title||(c.popup.title=""),this.popupConfig.setConfig({title:c.popup.title,fields:c.popup.fields,orderByFields:c.orderByFields}),this.popupConfig.updateSortingIcon(b),this._isTable(b)?(this._hideSymbolSection(),this.layerSymbolPicker.reset()):(this._showSymbolSection(),c.resultsSymbol&&(c=x.fromJson(c.resultsSymbol),
this.layerSymbolPicker.showBySymbol(c))))},_isObject:function(a){return a&&"object"===typeof a}})});