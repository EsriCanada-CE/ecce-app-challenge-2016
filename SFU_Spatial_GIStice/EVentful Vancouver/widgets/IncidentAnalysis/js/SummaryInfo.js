// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/array dojo/_base/lang dojo/_base/Color dojo/dom dojo/dom-class dojo/dom-construct dojo/dom-style dojo/number dojo/on dojo/has dijit/form/Button jimu/dijit/Popup jimu/CSVUtils jimu/utils esri/config esri/geometry/geometryEngine esri/geometry/mathUtils esri/geometry/Point esri/geometry/webMercatorUtils esri/graphic esri/layers/FeatureLayer esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/Font esri/symbols/TextSymbol esri/tasks/query".split(" "),
function(q,k,g,v,l,f,h,w,r,m,x,y,z,s,t,A,n,B,C,D,E,u,F,G,H,I,p){return q("SummaryInfo",null,{summaryLayer:null,summaryFields:[],summaryIds:[],summaryFeatures:[],constructor:function(b,a,c){this.tab=b;this.container=a;this.parent=c;this.config=c.config},updateForIncident:function(b,a){this.container.innerHTML="";f.add(this.container,"loading");this.summaryIds=[];this.summaryFeatures=[];if(0<this.tab.tabLayers.length)if("undefined"!==typeof this.tab.tabLayers[0].infoTemplate)this.summaryLayer=this.tab.tabLayers[0],
this.summaryFields=this._getFields(this.summaryLayer),g.hitch(this,this._queryFeatures(a.geometry));else{var c=new u(this.tab.tabLayers[0].url);m(c,"load",g.hitch(this,function(){this.summaryLayer=c;this.summaryFields=this._getFields(this.summaryLayer);g.hitch(this,this._queryFeatures(a.geometry))}))}},_queryFeatures:function(b){var a=new p;a.geometry=b;this.summaryLayer.queryIds(a,g.hitch(this,function(a){a?(this.summaryIds=a,0<this.summaryIds.length?this._queryFeaturesByIds():this._processResults()):
this._processResults()}))},_queryFeaturesByIds:function(){var b=this.summaryLayer.maxRecordCount||1E3,a=this.summaryIds.slice(0,b);this.summaryIds.splice(0,b);var b=new p,c=!1;k.some(this.summaryFields,function(a){if("area"===a.type||"length"===a.type)return c=!0});b.returnGeometry=c;var d=[];k.forEach(this.summaryFields,function(a){d.push(a.field)});b.outFields=d;b.objectIds=a;this.summaryLayer.queryFeatures(b,g.hitch(this,function(a){this.summaryFeatures=this.summaryFeatures.concat(a.features);
this._processResults();0<this.summaryIds.length?(l.byId("IMT_download")&&f.replace(l.byId("IMT_download"),"processing","download"),setTimeout(g.hitch(this,this._queryFeaturesByIds),900)):l.byId("IMT_download")&&f.replace(l.byId("IMT_download"),"download","processing")}))},_prepResults:function(){for(var b=0;b<this.summaryFields.length;b++){var a=this.summaryFields[b],c=a.field,d=a.value;switch(a.type){case "count":d=this.summaryFeatures.length;break;case "area":d=this._getArea();break;case "length":d=
this._getLength();break;case "sum":d=this._getSum(c);break;case "avg":d=this._getSum(c)/this.summaryFeatures.length;break;case "min":d=this._getMin(c);break;case "max":d=this._getMax(c)}a.value=d}},_sortResults:function(b){return function(a,c){return a.attributes[b]<c.attributes[b]?-1:a.attributes[b]>c.attributes[b]?1:0}},_getSum:function(b){var a=0;k.forEach(this.summaryFeatures,function(c){a+=c.attributes[b]});return a},_getMin:function(b){this.summaryFeatures.sort(this._sortResults(b));return this.summaryFeatures[0].attributes[b]},
_getMax:function(b){this.summaryFeatures.sort(this._sortResults(b));this.summaryFeatures.reverse();return this.summaryFeatures[0].attributes[b]},_getArea:function(){var b=0,a=g.clone(this.config.distanceSettings);a.miles=109413;a.kilometers=109414;a.feet=109405;a.meters=109404;a.yards=109442;a.nauticalMiles=109409;var c=a[this.config.distanceUnits];k.forEach(this.summaryFeatures,function(a){b+=n.geodesicArea(a.geometry,c)});return b},_getLength:function(){var b=0,a=this.config.distanceSettings[this.config.distanceUnits];
k.forEach(this.summaryFeatures,function(c){b+=n.geodesicLength(c.geometry,a)});return b},_processResults:function(){this._prepResults();this.container.innerHTML="";f.remove(this.container,"loading");var b=this.summaryFields,a=0,c=h.create("div",{id:"tpc",style:"width:"+220*(b.length+1)+"px;"},this.container);f.add(c,"IMT_tabPanelContent");var d=h.create("div",{},c);f.add(d,"IMTcol");d=h.create("div",{id:"IMT_download",innerHTML:this.parent.nls.downloadCSV},d);f.add(d,["btnExport","download"]);m(d,
"click",g.hitch(this,this._exportToCSV));for(d=0;d<b.length;d++){var a=b[d],e=t.sanitizeHTML(a.alias?a.alias:"")+"\x3cbr/\x3e",a=a.alias===this.parent.nls.area||a.alias===this.parent.nls.length?a.value:Math.round(a.value);isNaN(a)&&(a=0);e+="\x3cdiv class\x3d'colSummary'\x3e"+r.format(a)+"\x3c/div\x3e\x3cbr/\x3e";e=h.create("div",{id:"Demographics_"+d,innerHTML:e},c);f.add(e,"IMTcol")}},_exportToCSV:function(){if(0===this.summaryFeatures.length)return!1;console.log(this.tab);var b=this.tab.layers,
a=[],c=[];k.forEach(this.summaryFeatures,function(b){a.push(b.attributes)});for(var d in a[0])c.push(d);s.exportCSV(b,a,c)},_getFields:function(b){var a=[];if(this.tab.advConfig&&this.tab.advConfig.fields&&0<this.tab.advConfig.fields.length)return k.forEach(this.tab.advConfig.fields,g.hitch(this,function(b){var c="";"count"!==b.type&&("area"!==b.type&&"length"!==b.type)&&(c=" (\x3cspan style\x3d'font-size:7pt;'\x3e"+this.parent.nls[b.type]+"\x3c/span\x3e)");a.push({field:b.expression,alias:b.label+
c,type:b.type,value:0})})),a;var c;c=b.infoTemplate?b.infoTemplate.info.fieldInfos:b.fields;for(var d=0;d<c.length;d++){var e=c[d],f=e.fieldName||e.name,l=this._getFieldType(b.fields,f),h=null;if(f!==b.objectIdField&&("esriFieldTypeDouble"===l||"esriFieldTypeInteger"===l||"esriFieldTypeSmallInteger"===l))"undefined"!==typeof e.visible?e.visible&&(h={field:e.fieldName,alias:e.label,type:"sum",value:0}):h={field:e.name,alias:e.alias,type:"sum",value:0},h&&a.push(h)}return a},_getFieldType:function(b,
a){var c;k.some(b,function(b){if(b.name===a)return c=b.type,!0});return c}})});